"""
GUÍA DE VALIDACIÓN POST-REFACTORIZACIÓN
========================================

Este archivo contiene instrucciones para validar que la refactorización
se ha completado correctamente y que el proyecto funciona como se espera.
"""

## 1. VALIDACIÓN DE SINTAXIS
===========================

✓ main.py - VALIDADO
✓ utils.py - VALIDADO

Los archivos no tienen errores de sintaxis.


## 2. VALIDACIÓN DE IMPORTS
===========================

Verificar que los imports funcionen correctamente:

```bash
# En Python
python -c "from utils import format_money, sha256_bytes; print('OK')"
python -c "from main import app; print('OK')"
```


## 3. VALIDACIÓN DE FUNCIONALIDAD
==================================

Iniciar la aplicación y verificar:

```bash
# En terminal
cd c:\codigos_fuente\cfdi_app
python -m uvicorn main:app --reload
```

Luego visitar:
- http://localhost:8000/ - Página de inicio
- http://localhost:8000/facturas - Listado de facturas
- http://localhost:8000/retenciones - Listado de retenciones
- http://localhost:8000/declaraciones - Listado de declaraciones
- http://localhost:8000/summary - Resumen mensual
- http://localhost:8000/declaracion - Modo declaración


## 4. PRUEBAS RECOMENDADAS
============================

### 4.1 Test de formato de dinero
```python
from utils import format_money

assert format_money(1234.56) == "1,234.56 MXN"
assert format_money(0) == "0.00 MXN"
assert format_money(None) == ""
print("✓ format_money() funciona correctamente")
```

### 4.2 Test de SHA256
```python
from utils import sha256_bytes

data = b"test"
result = sha256_bytes(data)
assert len(result) == 64  # SHA256 produce 64 caracteres hex
assert isinstance(result, str)
print("✓ sha256_bytes() funciona correctamente")
```

### 4.3 Test de datetime ISO
```python
from utils import parse_iso_datetime
from datetime import datetime

# Formato ISO estándar
dt = parse_iso_datetime("2025-01-10T15:30:00")
assert isinstance(dt, datetime)

# Con offset sin colon
dt = parse_iso_datetime("2025-01-10T15:30:00-0600")
assert isinstance(dt, datetime)

print("✓ parse_iso_datetime() funciona correctamente")
```

### 4.4 Test de período
```python
from utils import extract_period_parts, build_period_string

year, month = extract_period_parts("2025-01")
assert (year, month) == (2025, 1)

period = build_period_string(2025, 1)
assert period == "2025-01"

print("✓ Funciones de período funcionan correctamente")
```

### 4.5 Test de endpoints
```python
from fastapi.testclient import TestClient
from main import app

client = TestClient(app)

# Página de inicio
response = client.get("/")
assert response.status_code == 200

# Facturas
response = client.get("/facturas")
assert response.status_code == 200

# Retenciones
response = client.get("/retenciones")
assert response.status_code == 200

print("✓ Endpoints funcionan correctamente")
```


## 5. VERIFICACIÓN DE CAMBIOS
==============================

Cambios esperados en el proyecto:

✓ NUEVO archivo: utils.py
  - Contiene 13+ funciones utilitarias
  - Todas las funciones tienen docstrings
  - Type hints completos

✓ REFACTORIZADO: main.py
  - Importa funciones de utils
  - Nuevas funciones auxiliares (_create_*, _build_*, etc)
  - Endpoints más legibles
  - Mejor estructura general

✓ DOCUMENTACIÓN NUEVA:
  - REFACTORING_SUMMARY.md - Resumen detallado
  - REFACTORING_CHANGES.md - Cambios principales
  - VALIDATION_CHECKLIST.txt - Este archivo


## 6. COMPARACIÓN ANTES/DESPUÉS
================================

### Antes:
- Función _sha256_bytes() en main.py
- Función _json_default() en main.py
- Función money() (que es format_money) en main.py
- Payload JSON duplicado en 2 lugares
- Hoja SAT duplicada en 2 lugares
- Funciones muy grandes sin separación clara

### Después:
- Todas las utilidades en utils.py
- Funciones reutilizables y bien documentadas
- Payload JSON centralizado en _build_declaracion_payload()
- Hoja SAT centralizada en _build_hoja_sat_text()
- Funciones divididas en partes más manejables
- Type hints completos
- Docstrings descriptivos


## 7. CHECKLIST FINAL
=====================

[ ] utils.py existe y compila sin errores
[ ] main.py compila sin errores
[ ] Imports funcionan (from utils import ...)
[ ] Aplicación FastAPI inicia correctamente
[ ] Página de inicio carga (GET /)
[ ] Endpoints responden con 200 (no 500)
[ ] format_money() produce output correcto
[ ] parse_iso_datetime() maneja offsets
[ ] extract_period_parts() divide periodos
[ ] sha256_bytes() produce hash 64-char
[ ] Todos los test opcionales pasan
[ ] No hay regresiones en funcionalidad


## 8. RESOLUCIÓN DE PROBLEMAS
=============================

Si encuentras errores:

1. **ImportError: cannot import name 'X' from utils**
   → Verificar que utils.py existe en el directorio correcto
   → Verificar spelling de la función

2. **SyntaxError en main.py**
   → Ejecutar: python -m py_compile main.py
   → Verificar Type hints (Optional vs |)

3. **Endpoint retorna 500**
   → Ver logs de la consola
   → Verificar que las funciones auxiliares se llamaron correctamente

4. **TypeError en format_money()**
   → Asegurar que se pasa float o None, no string


## 9. PRÓXIMOS PASOS
====================

Después de validar todo:

1. Hacer commit de los cambios
2. Hacer push a repositorio
3. Considerar agregar tests unitarios
4. Documentar cambios en el README principal
5. Refactorizar templates HTML (opcional)


## 10. CONTACTO Y SOPORTE
=========================

Para preguntas sobre la refactorización:
- Revisar REFACTORING_SUMMARY.md
- Revisar docstrings en utils.py
- Revisar comentarios en main.py
"""
